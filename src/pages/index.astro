---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../consts';

// Fetch cat image from The Cat API at build/server time
const res = await fetch('https://api.thecatapi.com/v1/images/search?breed_ids=mcoo,norw,ragd,sibe,birm');
let catImageUrl = null;
if (res.ok) {
    const data = await res.json() as Array<{ url?: string }>;
    catImageUrl = data?.[0]?.url ?? null;
}
---

<style>
  main h1 { text-align: center; }

  /* center and constrain the cat image below the header */
  .cat-image {
    display: flex;
    justify-content: center;
    margin: 1.5rem 0;
  }
  .cat-image img {
    max-width: 150%;
    width: min(720px, 90%);
    height: auto;
    border-radius: 8px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.08);
  }
</style>

<!doctype html>
<html lang="en">
    <head>
        <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
    </head>
    <body>
        <Header />
        <main>
            <h1>neko</h1>
            <!-- cat image from API -->
            {catImageUrl ? (
                <div class="cat-image">
                    <img id="cat-img" src={catImageUrl} alt="Cat image from The Cat API" />
                </div>
            ) : (
                <div class="cat-image">
                    <p id="cat-placeholder">Unable to load cat image.</p>
                </div>
            )}
        </main>
        <Footer />

        <script type="module">
        // Fetch a new ragdoll image when the site title or "more nekos" link is clicked
        const title = document.getElementById('site-title');
        const moreNekos = document.getElementById('more-nekos');
        const container = document.querySelector('.cat-image');

        async function fetchNewCat() {
          try {
            const res = await fetch('https://api.thecatapi.com/v1/images/search?breed_ids=mcoo,norw,ragd,sibe,birm');
            if (!res.ok) return;
            const data = await res.json();
            const url = data?.[0]?.url;
            if (!url) return;
            let img = document.getElementById('cat-img');
            if (!img) {
              img = document.createElement('img');
              img.id = 'cat-img';
              container.innerHTML = '';
              container.appendChild(img);
            }
            img.src = url;
            img.alt = 'Cat image from The Cat API';
          } catch (err) {
            console.error('Failed to fetch cat image', err);
          }
        }

        // prevent navigation and fetch a new image instead
        title?.addEventListener('click', (e) => {
          e.preventDefault();
          fetchNewCat();
        });

        moreNekos?.addEventListener('click', (e) => {
          e.preventDefault();
          fetchNewCat();
        });
        </script>
    </body>
</html>